<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì‹¬í”Œ ì›¹ ì—ë””í„° (Range/Selection)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin: 0 0 12px; }
    .toolbar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .toolbar button, .toolbar select {
      padding: 6px 10px; cursor: pointer;
    }
    #editor {
      border: 1px solid #ccc;
      min-height: 180px;
      padding: 10px;
      margin-top: 12px;
      outline: none;
    }
    #result {
      border: 1px dashed #aaa;
      margin-top: 10px;
      padding: 10px;
      background: #fafafa;
      white-space: pre-wrap;
    }
    .hint { color:#666; font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>ğŸ“ ì‹¬í”Œ ì›¹ ì—ë””í„° (Range/Selection)</h1>

  <div class="toolbar">
    <button type="button" id="btnBold"><strong>êµµê²Œ</strong></button>
    <button type="button" id="btnItalic"><em>ê¸°ìš¸ì„</em></button>
    <button type="button" id="btnUnderline"><u>ë°‘ì¤„</u></button>

    <select id="colorSelect">
      <option value="">ê¸€ììƒ‰</option>
      <option value="black">ê²€ì •</option>
      <option value="red">ë¹¨ê°•</option>
      <option value="blue">íŒŒë‘</option>
      <option value="green">ì´ˆë¡</option>
      <option value="#f4b400">ë…¸ë‘(ì§„í•œ)</option>
    </select>

    <select id="blockSelect">
      <option value="p">ë³¸ë¬¸(p)</option>
      <option value="h1">ì œëª© 1(h1)</option>
      <option value="h2">ì œëª© 2(h2)</option>
      <option value="h3">ì œëª© 3(h3)</option>
    </select>

    <button type="button" id="btnSave">ì €ì¥</button>
  </div>

  <div class="hint">í…ìŠ¤íŠ¸ë¥¼ ë“œë˜ê·¸ë¡œ ì„ íƒí•œ ë’¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ì„¸ìš”. (ì„ íƒì´ ì—†ìœ¼ë©´ ì ìš©ë˜ì§€ ì•ŠìŒ)</div>

  <div id="editor" contenteditable="true" spellcheck="true">
    ì—¬ê¸°ì— ë¬¸ì¥ì„ ì…ë ¥í•˜ê³  ì›í•˜ëŠ” ìŠ¤íƒ€ì¼ì„ ì ìš©í•´ ë³´ì„¸ìš”!
  </div>

  <h3>ğŸ“„ ì €ì¥ëœ HTML ê²°ê³¼</h3>
  <div id="result"></div>

  <script>
    const editor = document.getElementById("editor");
    const result = document.getElementById("result");

    // ì—ë””í„° ë‚´ë¶€ ì„ íƒì¸ì§€ í™•ì¸í•˜ê³  Range ë°˜í™˜
    function getEditorRange() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return null;

      const range = sel.getRangeAt(0);

      // ì„ íƒì´ ì—ë””í„° ë‚´ë¶€ì¸ì§€ í™•ì¸
      const startInEditor = editor.contains(range.startContainer);
      const endInEditor = editor.contains(range.endContainer);
      if (!startInEditor || !endInEditor) return null;

      // ì„ íƒëœ í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´(null)
      if (range.collapsed) return null;

      return range;
    }

    // ì„ íƒ ì˜ì—­ì„ spanìœ¼ë¡œ ê°ì‹¸ style ì ìš© (inline ìŠ¤íƒ€ì¼)
    function wrapSelectionWithSpan(styleObj) {
      const range = getEditorRange();
      if (!range) {
        alert("ì—ë””í„° ì•ˆì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }

      const span = document.createElement("span");
      Object.assign(span.style, styleObj);

      // extractContentsë¡œ ì„ íƒ ì˜ì—­ë§Œ ë½‘ì•„ spanì— ë„£ê³  ë‹¤ì‹œ ì‚½ì…
      const content = range.extractContents();
      span.appendChild(content);
      range.insertNode(span);

      // ì„ íƒì„ ë°©ê¸ˆ ë§Œë“  span ë’¤ë¡œ ì´ë™(UX)
      const sel = window.getSelection();
      sel.removeAllRanges();
      const newRange = document.createRange();
      newRange.setStartAfter(span);
      newRange.collapse(true);
      sel.addRange(newRange);

      editor.focus();
    }

    // ë¸”ë¡(ë¬¸ë‹¨/ì œëª©) ë³€ê²½: ì„ íƒëœ Rangeì˜ ê³µí†µ ì¡°ìƒ ë¸”ë¡ì„ ì°¾ì•„ íƒœê·¸ êµì²´
    function changeBlockTag(tagName) {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return;

      const range = sel.getRangeAt(0);
      const startInEditor = editor.contains(range.startContainer);
      const endInEditor = editor.contains(range.endContainer);
      if (!startInEditor || !endInEditor) {
        alert("ì—ë””í„° ì•ˆì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì»¤ì„œë¥¼ ë‘ê³  ì‹¤í–‰í•´ ì£¼ì„¸ìš”.");
        return;
      }

      // ì„ íƒì´ ì—†ì–´ë„(ì»¤ì„œë§Œ ìˆì–´ë„) í˜„ì¬ ë¸”ë¡ ë°”ê¾¸ê¸° ì§€ì›
      let node = range.startContainer;
      if (node.nodeType === Node.TEXT_NODE) node = node.parentNode;

      // editor ë°”ë¡œ ì•„ë˜ì— ìˆëŠ” ë¸”ë¡(p/div/h*) ì°¾ê¸°
      let block = node;
      while (block && block !== editor) {
        const name = block.nodeName.toLowerCase();
        if (["p","div","h1","h2","h3","h4","h5","h6"].includes(name)) break;
        block = block.parentNode;
      }

      // ë¸”ë¡ì´ ì—†ê±°ë‚˜ editor ìì²´ë©´ pë¡œ ê°ì‹¸ê¸°
      if (!block || block === editor) {
        // ì»¤ì„œ ê¸°ì¤€ìœ¼ë¡œ í•œ ì¤„ ë§Œë“¤ê¸°: í˜„ì¬ selection ìœ„ì¹˜ì— p ì‚½ì…
        const p = document.createElement(tagName);
        p.innerHTML = "<br>";
        range.insertNode(p);

        // ì»¤ì„œ ì´ë™
        sel.removeAllRanges();
        const nr = document.createRange();
        nr.selectNodeContents(p);
        nr.collapse(true);
        sel.addRange(nr);
        editor.focus();
        return;
      }

      // ê°™ì€ íƒœê·¸ë©´ ì¢…ë£Œ
      if (block.nodeName.toLowerCase() === tagName) return;

      // íƒœê·¸ êµì²´
      const newBlock = document.createElement(tagName);
      // ì†ì„± ì¼ë¶€ ìœ ì§€(ì›í•˜ë©´ class/idë„ ë³µì‚¬ ê°€ëŠ¥)
      newBlock.innerHTML = block.innerHTML;
      block.replaceWith(newBlock);

      editor.focus();
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("btnBold").addEventListener("click", () => {
      wrapSelectionWithSpan({ fontWeight: "700" });
    });

    document.getElementById("btnItalic").addEventListener("click", () => {
      wrapSelectionWithSpan({ fontStyle: "italic" });
    });

    document.getElementById("btnUnderline").addEventListener("click", () => {
      wrapSelectionWithSpan({ textDecoration: "underline" });
    });

    document.getElementById("colorSelect").addEventListener("change", (e) => {
      const color = e.target.value;
      if (!color) return;
      wrapSelectionWithSpan({ color });
      e.target.value = ""; // ì„ íƒ ì´ˆê¸°í™”
    });

    document.getElementById("blockSelect").addEventListener("change", (e) => {
      const tag = e.target.value;
      changeBlockTag(tag);
    });

    document.getElementById("btnSave").addEventListener("click", () => {
      result.textContent = editor.innerHTML;
    });
  </script>
</body>
</html>